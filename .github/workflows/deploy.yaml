name: Deploy to netlify

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      destroy:
        description: 'Destroy infrastructure (type "destroy" to confirm)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  deploy:
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.destroy != 'destroy' }}
    name: Deploy to Vercel
    # needs: terraform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci
        
      - name: Ensure Netlify Site Exists
        id: ensure_netlify_site
        run: |
          SITE_ID=${{ secrets.NETLIFY_SITE_ID }}
          AUTH_TOKEN=${{ secrets.NETLIFY_AUTH_TOKEN }}
          RESPONSE=$(curl -s -H "Authorization: Bearer $AUTH_TOKEN" "https://api.netlify.com/api/v1/sites/$SITE_ID")
          if echo "$RESPONSE" | grep -q '"id":'; then
            echo "Netlify site exists."
            # Optionally, you can output the existing site ID
            echo "::set-output name=existing_site_id::$SITE_ID"
          else
            echo "Netlify site does not exist. Creating a new site..."
            CREATE_RESPONSE=$(curl -s -X POST -H "Authorization: Bearer $AUTH_TOKEN" -H "Content-Type: application/json" -d '{"name":"my-new-site"}' "https://api.netlify.com/api/v1/sites")
            NEW_SITE_ID=$(echo "$CREATE_RESPONSE" | grep -oP '"id":"\K[^"]+')
            echo "New site created with ID: $NEW_SITE_ID"
            echo "::set-output name=existing_site_id::$NEW_SITE_ID"
          fi

      - name: Build Project
        run: npm run build  

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v1.2.4
        with:
          publish-dir: './public'
          production-branch: 'main'
          netlify-auth-token: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          netlify-site-id: ${{ steps.ensure_netlify_site.outputs.existing_site_id }}


  destroy:
    name: Destroy Infrastructure
    if: github.event.inputs.destroy == 'destroy'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure Netlify Site Exists
        id: ensure_netlify_site
        run: |
          SITE_ID=${{ secrets.NETLIFY_SITE_ID }}
          AUTH_TOKEN=${{ secrets.NETLIFY_AUTH_TOKEN }}
          RESPONSE=$(curl -s -H "Authorization: Bearer $AUTH_TOKEN" "https://api.netlify.com/api/v1/sites/$SITE_ID")
          if echo "$RESPONSE" | grep -q '"id":'; then
            echo "Netlify site exists."
            # Optionally, you can output the existing site ID
            echo "::set-output name=existing_site_id::$SITE_ID"
          else
            echo "Netlify site does not exist. Nothing to destroy."
          fi

      - name: Destroy Netlify Site
        run: |
          curl -X DELETE \
            -H "Authorization: Bearer ${{ secrets.NETLIFY_AUTH_TOKEN }}" \
            "https://api.netlify.com/api/v1/sites/${{ steps.ensure_netlify_site.outputs.existing_site_id }}"     
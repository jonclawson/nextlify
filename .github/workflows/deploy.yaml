name: Deploy to netlify

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      destroy:
        description: 'Destroy infrastructure (type "destroy" to confirm)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  deploy:
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.destroy != 'destroy' }}
    name: Deploy to Netlify
    # needs: terraform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Ensure Netlify Site Exists
        id: ensure_netlify_site
        run: |
          SITE_NAME=${{ secrets.NETLIFY_SITE_NAME || 'nextlify-deploy' }}
          AUTH_TOKEN=${{ secrets.NETLIFY_AUTH_TOKEN }}
          
          # Query all sites and find by name
          SITES_RESPONSE=$(curl -s -H "Authorization: Bearer $AUTH_TOKEN" "https://api.netlify.com/api/v1/sites")
          echo "API Response: $SITES_RESPONSE"
          SITE_ID=$(echo "$SITES_RESPONSE" | jq -r ".[] | select(.name==\"$SITE_NAME\") | .id" | head -1)
          
          if [ -z "$SITE_ID" ]; then
            echo "Site '$SITE_NAME' not found. Creating a new site..."
            CREATE_RESPONSE=$(curl -s -X POST -H "Authorization: Bearer $AUTH_TOKEN" -H "Content-Type: application/json" -d '{"name":"'$SITE_NAME'"}' "https://api.netlify.com/api/v1/sites")
            echo "API Response: $CREATE_RESPONSE"
            NEW_SITE_ID=$(echo "$CREATE_RESPONSE" | jq -r '.id')
            if [ -z "$NEW_SITE_ID" ]; then
              echo "Error: Failed to extract site ID from response"
              exit 1
            fi
            echo "New site created with ID: $NEW_SITE_ID"
            echo "existing_site_id=$NEW_SITE_ID" >> $GITHUB_OUTPUT
          else
            echo "Site '$SITE_NAME' found with ID: $SITE_ID"
            echo "existing_site_id=$SITE_ID" >> $GITHUB_OUTPUT
          fi

      - name: Install Dependencies
        run: npm ci

      - name: Build Project
        run: npm run build  

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: '.next'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions"
          # enable-pull-request-comment: false
          # enable-commit-comment: true
          # overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ steps.ensure_netlify_site.outputs.existing_site_id }}


  destroy:
    name: Destroy Infrastructure
    if: github.event.inputs.destroy == 'destroy'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure Netlify Site Exists
        id: ensure_netlify_site
        run: |
          AUTH_TOKEN=${{ secrets.NETLIFY_AUTH_TOKEN }}
          
          # Query all sites and find by name
          SITES_RESPONSE=$(curl -s -H "Authorization: Bearer $AUTH_TOKEN" "https://api.netlify.com/api/v1/sites")
          SITE_ID=$(echo "$SITES_RESPONSE" | jq -r ".[] | select(.name==\"$SITE_NAME\") | .id" | head -1)
          
          if [ -z "$SITE_ID" ]; then
            echo "Site '$SITE_NAME' not found. Nothing to destroy."
          else
            echo "Site '$SITE_NAME' found with ID: $SITE_ID"
            echo "existing_site_id=$SITE_ID" >> $GITHUB_OUTPUT
          fi

      - name: Destroy Netlify Site
        run: |
          curl -X DELETE \
            -H "Authorization: Bearer ${{ secrets.NETLIFY_AUTH_TOKEN }}" \
            "https://api.netlify.com/api/v1/sites/${{ steps.ensure_netlify_site.outputs.existing_site_id }}"     